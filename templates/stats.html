<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>{{ current_period_label }} Incident Stats</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}" />
</head>
<body>
    <div class="page">
        <div class="page-header">
            <h1>{{ current_period_label }} Incident Stats</h1>
            <div class="header-links">
                <a class="admin-link" href="{{ url_for('index') }}">Dashboard</a>
                <a class="admin-link" href="{{ url_for('graphs_view') }}">Graphs</a>
            </div>
        </div>

        <div class="calendar-header">
            <div class="calendar-nav">
                <a class="icon-button icon-only" href="{{ prev_link }}" aria-label="Previous period">&#9664;</a>
                <div class="current-period">{{ current_period_label }}</div>
                <a class="icon-button icon-only" href="{{ next_link }}" aria-label="Next period">&#9654;</a>
            </div>
            <div class="calendar-actions">
                <div class="view-toggle" role="group" aria-label="Stats view toggle">
                    <a class="icon-button icon-only {% if view_mode == 'yearly' %}active{% endif %}" href="{{ yearly_view_link }}" aria-label="Year view">&#128197;</a>
                    <a class="icon-button icon-only {% if view_mode == 'quarterly' %}active{% endif %}" href="{{ quarterly_view_link }}" aria-label="Quarter view">Q</a>
                    <a class="icon-button icon-only {% if view_mode == 'monthly' %}active{% endif %}" href="{{ monthly_view_link }}" aria-label="Month view">&#128198;</a>
                </div>
            </div>
        </div>

        <form class="control-form" method="GET" action="{{ url_for('stats_view') }}">
            <input type="hidden" name="view" value="{{ view_mode }}" />
            {% if month_selection %}
            <input type="hidden" name="month" value="{{ month_selection }}" />
            {% endif %}
            {% if quarter_selection %}
            <input type="hidden" name="quarter" value="{{ quarter_selection }}" />
            {% endif %}
            <div class="control-row">
                <label>
                    Year
                    <select name="year">
                        {% for option_year in available_years %}
                        <option value="{{ option_year }}" {% if option_year == year %}selected{% endif %}>{{ option_year }}</option>
                        {% endfor %}
                    </select>
                </label>

                <label>
                    Pillar
                    <select name="pillar">
                        <option value="">All</option>
                        {% for pillar in pillars %}
                        <option value="{{ pillar }}" {% if pillar_filter == pillar %}selected{% endif %}>{{ pillar }}</option>
                        {% endfor %}
                    </select>
                </label>

                <label>
                    Product
                    <select name="product">
                        <option value="">All</option>
                        {% for product in products %}
                        <option value="{{ product }}" {% if product_filter == product %}selected{% endif %}>{{ product }}</option>
                        {% endfor %}
                    </select>
                </label>

                <div class="checkbox-group">
                    <span class="field-label">Severities</span>
                    <div class="checkbox-row">
                        {% for value in severity_options %}
                        <label class="checkbox-inline">
                            <input
                                type="checkbox"
                                name="severity"
                                value="{{ value }}"
                                {% if value in severity_filter %}checked{% endif %}
                            />
                            Sev {{ value }}
                        </label>
                        {% endfor %}
                    </div>
                </div>

                <div class="control-actions">
                    <button type="submit" class="primary-button">Update</button>
                </div>
            </div>
        </form>

        <div class="filter-summary">
            {% if selected_filters %}
            <span class="filter-summary-label">Current filters:</span>
            <div class="filter-chip-row">
                {% for active_filter in selected_filters %}
                <span class="filter-chip">{{ active_filter.label }}: {{ active_filter.value }}</span>
                {% endfor %}
            </div>
            {% else %}
            <span class="filter-summary-label">Current filters: All</span>
            {% endif %}
        </div>

        <div class="stat-grid">
            <div class="stat-card">
                <p class="stat-label">Total incidents (selected severities)</p>
                <p class="stat-value">{{ total_incidents }}</p>
            </div>
            <div class="stat-card">
                <p class="stat-label">Self-inflicted incidents</p>
                <p class="stat-value">{{ classification_counts.self_inflicted }}</p>
            </div>
            <div class="stat-card">
                <p class="stat-label">Non-procedural incidents</p>
                <p class="stat-value">{{ classification_counts.non_procedural }}</p>
            </div>
            <div class="stat-card">
                <p class="stat-label">Unknown RCA classification</p>
                <p class="stat-value">{{ classification_counts.unknown }}</p>
            </div>
            <div class="stat-card highlight">
                <p class="stat-label">% self-inflicted</p>
                <p class="stat-value">{{ percent_self_inflicted }}%</p>
            </div>
        </div>

        <div class="table-card">
            <div class="table-card-header">
                <div>
                    <h2>Severity totals by month</h2>
                    <p class="helper-text">Counts update with the selected severities, pillar, product, and period.</p>
                </div>
            </div>
            <div class="table-wrapper">
                <table class="incidents-table stats-table">
                    <thead>
                        <tr>
                            <th>Severity</th>
                            {% for month in month_labels %}
                            <th>{{ month }}</th>
                            {% endfor %}
                            <th>Total</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for row in severity_rows %}
                        <tr class="{% if row.is_total %}total-row{% endif %}">
                            <td class="{% if not row.included_in_totals and not row.is_total %}excluded-severity{% endif %}">{{ row.label }}</td>
                            {% for value in row.months %}
                            <td class="{% if row.is_total %}table-total{% elif not row.included_in_totals %}excluded-severity{% endif %}">{{ value }}</td>
                            {% endfor %}
                            <td class="table-total{% if not row.included_in_totals and not row.is_total %} excluded-severity{% endif %}">{{ row.total }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</body>
</html>
